name: Governance Ripple Sync

# CI CLASSIFICATION: Governance Automation (Non-blocking)
# Purpose: Receive governance ripple events and trigger alignment
# Failure Semantics: Creates PR on drift, does not block merges
# Authority: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md v1.0.0
# Version: 1.0.0 (PartPulse)
# Created: 2026-02-14

on:
  repository_dispatch:
    types: [governance_ripple]
  
  # Manual trigger (for testing)
  workflow_dispatch:
    inputs:
      canonical_commit:
        description: 'Canonical commit SHA (optional, fetches latest if not provided)'
        required: false
        type: string
      inventory_version:
        description: 'Inventory version (optional)'
        required: false
        type: string
      dispatch_id:
        description: 'Test dispatch ID (optional, auto-generated if not provided)'
        required: false
        type: string

# Explicit, least-privilege permissions
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ============================================================================
  # GOVERNANCE RIPPLE RECEIVER
  # Receives push ripple from canonical governance repo
  # ============================================================================
  
  ripple-sync:
    name: Governance Ripple Receiver
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MATURION_BOT_TOKEN }}
      
      - name: Log Ripple Event
        id: log-ripple
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  GOVERNANCE RIPPLE RECEIVED"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          
          # Extract payload (handle both repository_dispatch and workflow_dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use inputs
            EVENT_TYPE="manual"
            CANONICAL_COMMIT="${{ inputs.canonical_commit }}"
            INVENTORY_VERSION="${{ inputs.inventory_version }}"
            DISPATCH_ID="${{ inputs.dispatch_id }}"
            [ -z "$DISPATCH_ID" ] && DISPATCH_ID="manual-$(date +%s)"
            TIMESTAMP="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            SENDER="manual-trigger"
          else
            # Repository dispatch - use client_payload
            EVENT_TYPE="${{ github.event.action }}"
            CANONICAL_COMMIT="${{ github.event.client_payload.canonical_commit }}"
            INVENTORY_VERSION="${{ github.event.client_payload.inventory_version }}"
            DISPATCH_ID="${{ github.event.client_payload.dispatch_id }}"
            TIMESTAMP="${{ github.event.client_payload.timestamp }}"
            SENDER="${{ github.event.client_payload.sender }}"
          fi
          
          echo "Event Details:"
          echo "  Event Type: $EVENT_TYPE"
          echo "  Canonical Commit: $CANONICAL_COMMIT"
          echo "  Inventory Version: $INVENTORY_VERSION"
          echo "  Dispatch ID: $DISPATCH_ID"
          echo "  Timestamp: $TIMESTAMP"
          echo "  Sender: $SENDER"
          echo ""
          
          # Ensure governance directory exists
          mkdir -p .agent-admin/governance
          
          # Log to ripple-log.json
          RIPPLE_LOG=".agent-admin/governance/ripple-log.json"
          
          # Initialize if missing
          if [ ! -f "$RIPPLE_LOG" ]; then
            echo '{"ripple_events":[],"last_updated":null,"schema_version":"1.0.0"}' > "$RIPPLE_LOG"
          fi
          
          # Append event
          RIPPLE_ENTRY=$(jq -n \
            --arg event_type "$EVENT_TYPE" \
            --arg canonical_commit "$CANONICAL_COMMIT" \
            --arg inventory_version "$INVENTORY_VERSION" \
            --arg dispatch_id "$DISPATCH_ID" \
            --arg timestamp "$TIMESTAMP" \
            --arg sender "$SENDER" \
            --arg received "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '{
              event_type: $event_type,
              canonical_commit: $canonical_commit,
              inventory_version: $inventory_version,
              dispatch_id: $dispatch_id,
              timestamp: $timestamp,
              sender: $sender,
              received_at: $received,
              status: "received"
            }')
          
          jq --argjson event "$RIPPLE_ENTRY" \
             --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
             '.ripple_events += [$event] | .last_updated = $updated' \
             "$RIPPLE_LOG" > "$RIPPLE_LOG.tmp"
          mv "$RIPPLE_LOG.tmp" "$RIPPLE_LOG"
          
          echo "‚úÖ Ripple event logged to $RIPPLE_LOG"
          echo ""
          
          # Output for next steps
          echo "canonical_commit=$CANONICAL_COMMIT" >> $GITHUB_OUTPUT
          echo "inventory_version=$INVENTORY_VERSION" >> $GITHUB_OUTPUT
          echo "dispatch_id=$DISPATCH_ID" >> $GITHUB_OUTPUT
      
      - name: Execute Alignment Check
        id: align
        env:
          MATURION_BOT_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
        run: |
          echo "üîç Executing governance alignment check..."
          echo ""
          
          # Execute alignment script with canonical commit and version
          if .github/scripts/align-governance.sh "${{ steps.log-ripple.outputs.canonical_commit }}" "${{ steps.log-ripple.outputs.inventory_version }}"; then
            echo "alignment_status=aligned" >> $GITHUB_OUTPUT
            echo "‚úÖ Governance is aligned"
          else
            echo "alignment_status=drift" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Drift detected - alignment PR will be created"
          fi
      
      - name: Update Ripple Status
        if: always()
        run: |
          echo "üìù Updating ripple event status..."
          
          RIPPLE_LOG=".agent-admin/governance/ripple-log.json"
          DISPATCH_ID="${{ steps.log-ripple.outputs.dispatch_id }}"
          STATUS="${{ steps.align.outputs.alignment_status }}"
          
          if [ "$STATUS" = "aligned" ]; then
            FINAL_STATUS="completed"
          elif [ "$STATUS" = "drift" ]; then
            FINAL_STATUS="drift_detected"
          else
            FINAL_STATUS="failed"
          fi
          
          # Update the latest event status
          jq --arg dispatch_id "$DISPATCH_ID" \
             --arg status "$FINAL_STATUS" \
             --arg completed "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
             '(.ripple_events[] | select(.dispatch_id == $dispatch_id)) |= (. + {status: $status, completed_at: $completed})' \
             "$RIPPLE_LOG" > "$RIPPLE_LOG.tmp"
          mv "$RIPPLE_LOG.tmp" "$RIPPLE_LOG"
          
          echo "‚úÖ Ripple status updated: $FINAL_STATUS"
      
      - name: Report Ripple Summary
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MATURION_BOT_TOKEN }}
          script: |
            const status = '${{ steps.align.outputs.alignment_status }}';
            const canonicalCommit = '${{ steps.log-ripple.outputs.canonical_commit }}';
            const inventoryVersion = '${{ steps.log-ripple.outputs.inventory_version }}';
            const dispatchId = '${{ steps.log-ripple.outputs.dispatch_id }}';
            
            let emoji = status === 'aligned' ? '‚úÖ' : '‚ö†Ô∏è';
            let title = status === 'aligned' ? 'ALIGNED' : 'DRIFT DETECTED';
            
            let body = `${emoji} **GOVERNANCE RIPPLE: ${title}**\n\n`;
            body += `**Ripple Event**\n`;
            body += `- Dispatch ID: \`${dispatchId}\`\n`;
            body += `- Canonical Commit: \`${canonicalCommit}\`\n`;
            body += `- Inventory Version: \`${inventoryVersion}\`\n`;
            body += `- Sender: APGI-cmy/maturion-foreman-governance\n\n`;
            
            if (status === 'aligned') {
              body += `**Status**: Governance is aligned with canonical source\n\n`;
              body += `No action required - local governance matches canonical.\n`;
            } else if (status === 'drift') {
              body += `**Status**: Drift detected - alignment PR created\n\n`;
              body += `An alignment PR has been automatically created to synchronize\n`;
              body += `local governance with the canonical source.\n\n`;
              body += `**Next Steps**:\n`;
              body += `1. Review the alignment PR\n`;
              body += `2. Execute layer-down protocol per governance-liaison contract\n`;
              body += `3. Verify SHA256 hashes (REQ-CM-001)\n`;
              body += `4. Update local governance artifacts\n`;
            }
            
            body += `\n---\n\n`;
            body += `**Authority**: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md ¬ß 5\n`;
            body += `**SLA**: Alignment PR created within 30 minutes of drift detection\n`;
            
            // Create issue for tracking
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Governance Ripple: ${title}`,
              body: body,
              labels: ['governance-ripple-required', 'governance-only']
            });
