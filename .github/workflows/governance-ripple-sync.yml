name: Governance Ripple Sync

# CI CLASSIFICATION: Governance Automation (Non-blocking)
# Purpose: Receive governance ripple events and trigger alignment
# Failure Semantics: Creates PR on drift, does not block merges
# Authority: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md v1.0.0
# Version: 1.1.0 (PartPulse)
# Created: 2026-02-14
# Updated: 2026-02-15 - Fixed payload compatibility

on:
  repository_dispatch:
    types: [governance_ripple]
  workflow_dispatch:  # Manual trigger for testing

# Explicit, least-privilege permissions
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ============================================================================
  # GOVERNANCE RIPPLE RECEIVER
  # Receives push ripple from canonical governance repo
  # ============================================================================
  
  ripple-sync:
    name: Governance Ripple Receiver
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MATURION_BOT_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "Maturion Bot"
          git config --global user.email "bot@maturion.com"
      
      - name: Log Ripple Event
        id: log-ripple
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  GOVERNANCE RIPPLE RECEIVED"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          
          # Extract payload (canonical dispatch format)
          SOURCE_REPO="${{ github.event.client_payload.source_repo }}"
          CANONICAL_COMMIT="${{ github.event.client_payload.commit_sha }}"
          COMMIT_MESSAGE="${{ github.event.client_payload.commit_message }}"
          TIMESTAMP="${{ github.event.client_payload.timestamp }}"
          
          echo "Event Details:"
          echo "  Source Repo: $SOURCE_REPO"
          echo "  Canonical Commit: $CANONICAL_COMMIT"
          echo "  Commit Message: $COMMIT_MESSAGE"
          echo "  Timestamp: $TIMESTAMP"
          echo "  Received At: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo ""
          
          # Ensure governance directory exists
          mkdir -p .agent-admin/governance
          
          # Log to ripple-log.json
          RIPPLE_LOG=".agent-admin/governance/ripple-log.json"
          
          # Initialize if missing
          if [ ! -f "$RIPPLE_LOG" ]; then
            echo '{"ripple_events":[],"last_updated":null,"schema_version":"1.0.0"}' > "$RIPPLE_LOG"
          fi
          
          # Append event (using canonical format)
          RIPPLE_ENTRY=$(jq -n \
            --arg source_repo "$SOURCE_REPO" \
            --arg canonical_commit "$CANONICAL_COMMIT" \
            --arg commit_message "$COMMIT_MESSAGE" \
            --arg timestamp "$TIMESTAMP" \
            --arg received "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '{
              source_repo: $source_repo,
              canonical_commit: $canonical_commit,
              commit_message: $commit_message,
              timestamp: $timestamp,
              received_at: $received,
              status: "received"
            }')
          
          jq --argjson event "$RIPPLE_ENTRY" \
             --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
             '.ripple_events += [$event] | .last_updated = $updated' \
             "$RIPPLE_LOG" > "$RIPPLE_LOG.tmp"
          mv "$RIPPLE_LOG.tmp" "$RIPPLE_LOG"
          
          echo "‚úÖ Ripple event logged to $RIPPLE_LOG"
          echo ""
          
          # Output for next steps
          echo "canonical_commit=$CANONICAL_COMMIT" >> $GITHUB_OUTPUT
          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
      
      - name: Execute Alignment Check
        id: align
        env:
          MATURION_BOT_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
        run: |
          echo "üîç Executing governance alignment check..."
          echo ""
          
          # Execute alignment script with canonical commit (no inventory version from dispatch)
          if .github/scripts/align-governance.sh "${{ steps.log-ripple.outputs.canonical_commit }}"; then
            echo "alignment_status=aligned" >> $GITHUB_OUTPUT
            echo "‚úÖ Governance is aligned"
          else
            echo "alignment_status=drift" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Drift detected - alignment PR will be created"
          fi
      
      - name: Update Ripple Status
        if: always()
        run: |
          echo "üìù Updating ripple event status..."
          
          RIPPLE_LOG=".agent-admin/governance/ripple-log.json"
          CANONICAL_COMMIT="${{ steps.log-ripple.outputs.canonical_commit }}"
          STATUS="${{ steps.align.outputs.alignment_status }}"
          
          if [ "$STATUS" = "aligned" ]; then
            FINAL_STATUS="completed"
          elif [ "$STATUS" = "drift" ]; then
            FINAL_STATUS="drift_detected"
          else
            FINAL_STATUS="failed"
          fi
          
          # Update the latest event status (match by canonical_commit)
          jq --arg canonical_commit "$CANONICAL_COMMIT" \
             --arg status "$FINAL_STATUS" \
             --arg completed "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
             '(.ripple_events[] | select(.canonical_commit == $canonical_commit)) |= (. + {status: $status, completed_at: $completed})' \
             "$RIPPLE_LOG" > "$RIPPLE_LOG.tmp"
          mv "$RIPPLE_LOG.tmp" "$RIPPLE_LOG"
          
          echo "‚úÖ Ripple status updated: $FINAL_STATUS"
      
      - name: Report Ripple Summary
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MATURION_BOT_TOKEN }}
          script: |
            const status = '${{ steps.align.outputs.alignment_status }}';
            const canonicalCommit = '${{ steps.log-ripple.outputs.canonical_commit }}';
            const sourceRepo = '${{ steps.log-ripple.outputs.source_repo }}';
            
            let emoji = status === 'aligned' ? '‚úÖ' : '‚ö†Ô∏è';
            let title = status === 'aligned' ? 'ALIGNED' : 'DRIFT DETECTED';
            
            let body = `${emoji} **GOVERNANCE RIPPLE: ${title}**\n\n`;
            body += `**Ripple Event**\n`;
            body += `- Source Repo: \`${sourceRepo}\`\n`;
            body += `- Canonical Commit: \`${canonicalCommit}\`\n`;
            body += `- Received At: \`${new Date().toISOString()}\`\n\n`;
            
            if (status === 'aligned') {
              body += `**Status**: Governance is aligned with canonical source\n\n`;
              body += `No action required - local governance matches canonical.\n`;
            } else if (status === 'drift') {
              body += `**Status**: Drift detected - alignment PR created\n\n`;
              body += `An alignment PR has been automatically created to synchronize\n`;
              body += `local governance with the canonical source.\n\n`;
              body += `**Next Steps**:\n`;
              body += `1. Review the alignment PR\n`;
              body += `2. Execute layer-down protocol per governance-liaison contract\n`;
              body += `3. Verify SHA256 hashes (REQ-CM-001)\n`;
              body += `4. Update local governance artifacts\n`;
            }
            
            body += `\n---\n\n`;
            body += `**Authority**: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md ¬ß 5\n`;
            body += `**SLA**: Alignment PR created within 30 minutes of drift detection\n`;
            
            // Create issue for tracking
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Governance Ripple: ${title}`,
              body: body,
              labels: ['governance-ripple-required', 'governance-only']
            });
