name: QA Enforcement

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test-dodging-check:
    name: Test Dodging Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # CI Runtime Configuration - Explicit declaration of all runtime requirements
      CI: 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        env:
          # Use dummy PostgreSQL URL for prisma generate validation during postinstall
          DATABASE_URL: 'postgresql://testuser:testpass@localhost:5432/testdb'
        run: npm ci
      
      - name: Run Test Dodging Detector
        run: node qa/detect-test-dodging.js
      
      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "test-dodging-violation" "Test dodging detected in CI"
          echo "Evidence captured to qa/evidence/"

  qa-parking-check:
    name: QA Parking Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # CI Runtime Configuration
      CI: 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run QA Parking Watcher
        run: node qa/parking/watcher.js
      
      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "qa-parking-violation" "QA parking violations detected"

  governance-sync-check:
    name: Governance Sync Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # CI Runtime Configuration
      CI: 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Governance Sync Checker
        run: node qa/governance/sync-checker.js
      
      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "governance-sync-failure" "Governance not synchronized"

  test-execution:
    name: Test Suite Execution
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # PostgreSQL service for tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      # --------------------------------------------------
      # 1. Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2. Setup Node (NO CACHE, NO MAGIC)
      # --------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --------------------------------------------------
      # 3. Assert execution root invariants
      # --------------------------------------------------
      - name: Assert execution root invariants
        run: |
          echo "=== INVARIANT 1: Working directory ==="
          pwd
          
          echo "=== INVARIANT 2: Repository files exist ==="
          ls -la
          test -f package.json || (echo "‚ùå package.json missing" && exit 1)
          test -f package-lock.json || (echo "‚ùå package-lock.json missing" && exit 1)
          echo "‚úÖ Both package.json and package-lock.json exist"
          
          echo "=== INVARIANT 3: Jest declared in devDependencies ==="
          node -e "const pkg = require('./package.json'); if (!pkg.devDependencies || !pkg.devDependencies.jest) { console.error('‚ùå jest not in devDependencies'); process.exit(1); } console.log('‚úÖ jest declared:', pkg.devDependencies.jest);"

      # --------------------------------------------------
      # 4. Install with full visibility (no cache, verbose)
      # --------------------------------------------------
      - name: Install dependencies with full tracing
        env:
          # Use PostgreSQL service for tests
          DATABASE_URL: 'postgresql://testuser:testpass@localhost:5432/testdb'
          CI: 'true'
        run: |
          echo "=== npm version and config ==="
          npm --version
          npm config list
          
          echo "=== .npmrc (if exists) ==="
          cat .npmrc 2>/dev/null || echo "No .npmrc file"
          
          echo "=== Running: npm ci --include=dev --loglevel=verbose ==="
          npm ci --include=dev --loglevel=verbose
          
          echo "=== Post-install: Verify node_modules ==="
          test -d node_modules || (echo "‚ùå node_modules directory missing" && exit 1)
          echo "‚úÖ node_modules exists"
          
          echo "=== Post-install: Show dependency tree for jest ==="
          npm ls jest || echo "‚ö†Ô∏è npm ls jest failed (expected if jest not installed)"
          
          echo "=== Post-install: Check physical jest installation ==="
          if [ -d node_modules/jest ]; then
            echo "‚úÖ node_modules/jest EXISTS"
            ls -la node_modules/jest | head -20
          else
            echo "‚ùå node_modules/jest DOES NOT EXIST"
            echo "Listing node_modules root (first 50 entries):"
            ls node_modules | head -50
          fi
          
          echo "=== Post-install: Test jest resolution ==="
          if npx jest --version 2>/dev/null; then
            echo "‚úÖ npx jest works"
          else
            echo "‚ùå npx jest fails"
          fi
          
          echo "=== FINAL ASSERTION: jest must be resolvable ==="
          node -e "require.resolve('jest')" || (echo "‚ùå CRITICAL: jest cannot be resolved despite npm ci completing" && exit 1)
          echo "‚úÖ jest is resolvable at: $(node -e "console.log(require.resolve('jest'))")"

      # --------------------------------------------------
      # 5. Run tests
      # --------------------------------------------------
      - name: Run test suite
        env:
          NODE_ENV: test
          DATABASE_URL: 'postgresql://testuser:testpass@localhost:5432/testdb'
          CI: 'true'
        run: |
          echo "=== Running tests ==="
          npm run test:ci
      
      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "test-failure" "Test suite failed" "$(cat test-output.log 2>/dev/null || echo 'No logs')"
      
      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/
          retention-days: 30

  merge-gate:
    name: Merge Gate (Build-to-GREEN)
    runs-on: ubuntu-latest
    needs: [test-dodging-check, qa-parking-check, governance-sync-check, test-execution]
    if: always()
    permissions:
      contents: read
    env:
      # CI Runtime Configuration
      CI: 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check All Gates
        run: |
          echo "Checking merge gate status..."
          
          if [ "${{ needs.test-dodging-check.result }}" != "success" ]; then
            echo "‚ùå Test dodging check failed"
            exit 1
          fi
          
          if [ "${{ needs.qa-parking-check.result }}" != "success" ]; then
            echo "‚ùå QA parking check failed"
            exit 1
          fi
          
          if [ "${{ needs.governance-sync-check.result }}" != "success" ]; then
            echo "‚ùå Governance sync check failed"
            exit 1
          fi
          
          if [ "${{ needs.test-execution.result }}" != "success" ]; then
            echo "‚ùå Test execution failed"
            exit 1
          fi
          
          echo "‚úÖ All merge gates passed - Build-to-GREEN achieved"
      
      - name: Evidence Capture on Gate Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "merge-gate-failure" "Merge gate blocked - RED state detected"
          echo "üö® CATASTROPHIC FAILURE - Merge gate RED"
          echo "Evidence captured. Create catastrophic failure issue."
