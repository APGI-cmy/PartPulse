name: Governance Alignment Schedule

# CI CLASSIFICATION: Governance Automation (Non-blocking)
# Purpose: Scheduled fallback for governance alignment verification
# Failure Semantics: Creates PR on drift, does not block merges
# Authority: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md v1.0.0 ¬ß 2
# Version: 1.1.0 (PartPulse) - Added deduplication to prevent issue spam
# Created: 2026-02-14
# Updated: 2026-02-17 - Issue deduplication (PR #356)

on:
  schedule:
    - cron: '0 * * * *'  # Run hourly as mandated by CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md ¬ß 8
  workflow_dispatch:  # Allow manual triggering for testing

# Explicit, least-privilege permissions
permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ============================================================================
  # SCHEDULED GOVERNANCE ALIGNMENT
  # Fallback mechanism for missed ripple events
  # ============================================================================
  
  scheduled-alignment:
    name: Scheduled Alignment Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MATURION_BOT_TOKEN }}
      
      - name: Log Scheduled Check
        id: log-check
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  SCHEDULED GOVERNANCE ALIGNMENT CHECK"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "Check Type: Scheduled Fallback"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Authority: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md ¬ß 2"
          echo ""
          
          # Ensure governance directory exists
          mkdir -p .agent-admin/governance
          
          echo "check_id=scheduled-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: Execute Alignment Check
        id: align
        env:
          MATURION_BOT_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
          GH_TOKEN: ${{ secrets.MATURION_BOT_TOKEN }}
        run: |
          echo "üîç Executing scheduled alignment check..."
          echo ""
          
          # Execute alignment script without arguments (fetch latest)
          if .github/scripts/align-governance.sh; then
            echo "alignment_status=aligned" >> $GITHUB_OUTPUT
            echo "‚úÖ Governance is aligned"
          else
            echo "alignment_status=drift" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Drift detected - alignment PR created"
          fi
      
      - name: Report Summary
        if: always() && steps.align.outputs.alignment_status == 'drift'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MATURION_BOT_TOKEN }}
          script: |
            const status = '${{ steps.align.outputs.alignment_status }}';
            const checkId = '${{ steps.log-check.outputs.check_id }}';
            
            if (status !== 'drift') {
              console.log('No drift detected - skipping issue creation');
              return;
            }
            
            // Check for existing open scheduled drift detection issues to prevent spam
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'governance-ripple-required,governance-only',
              per_page: 100
            });
            
            // Filter for scheduled drift detection issues only
            const scheduledDriftIssues = existingIssues.data.filter(issue => 
              issue.title.includes('Scheduled Governance Alignment: Drift Detected')
            );
            
            const timestamp = new Date().toISOString();
            
            if (scheduledDriftIssues.length > 0) {
              // Update existing issue instead of creating duplicate
              const issueNumber = scheduledDriftIssues[0].number;
              console.log(`Found existing scheduled drift issue #${issueNumber} - updating instead of creating duplicate`);
              
              let updateBody = `‚ö†Ô∏è **Drift Still Detected** (Check ID: \`${checkId}\`)\n\n`;
              updateBody += `**Timestamp**: ${timestamp}\n`;
              updateBody += `**Status**: Drift persists - alignment PR should auto-merge once checks pass\n\n`;
              updateBody += `The governance alignment PR (\`governance-alignment-auto\` branch) is still pending.\n`;
              updateBody += `Auto-merge is enabled and will complete automatically once all CI checks pass.\n\n`;
              updateBody += `If this issue persists for >24 hours, investigate for new bugs or check CI failures.\n`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: updateBody
              });
              
              console.log(`Updated existing issue #${issueNumber} with new drift check`);
              return;
            }
            
            // No existing issue - create new one
            console.log('No existing scheduled drift issue found - creating new issue');
            
            let body = `‚ö†Ô∏è **SCHEDULED GOVERNANCE ALIGNMENT: DRIFT DETECTED**\n\n`;
            body += `**Scheduled Check**\n`;
            body += `- Check ID: \`${checkId}\`\n`;
            body += `- Check Type: Scheduled Fallback (Hourly)\n`;
            body += `- Timestamp: ${timestamp}\n\n`;
            
            body += `**Status**: Drift detected during scheduled alignment check\n\n`;
            body += `An alignment PR has been automatically created to synchronize\n`;
            body += `local governance with the canonical source.\n\n`;
            
            body += `**Context**: This scheduled check runs hourly as a fallback mechanism\n`;
            body += `to recover from missed repository_dispatch events (¬ß 2 of transport protocol).\n\n`;
            
            body += `**Next Steps**:\n`;
            body += `1. Review the alignment PR created by align-governance.sh\n`;
            body += `2. Execute layer-down protocol per governance-liaison contract\n`;
            body += `3. Verify SHA256 hashes (REQ-CM-001)\n`;
            body += `4. Update local governance artifacts\n`;
            body += `5. Merge alignment PR to restore alignment\n\n`;
            
            body += `**Auto-Resolution**: This issue will be updated hourly until drift is resolved.\n`;
            body += `Close this issue manually once alignment PR is merged.\n\n`;
            
            body += `---\n\n`;
            body += `**Authority**: CROSS_REPO_RIPPLE_TRANSPORT_PROTOCOL.md ¬ß 2, ¬ß 8\n`;
            body += `**SLA**: Eventual consistency via hourly checks\n`;
            
            // Create issue for tracking
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Scheduled Governance Alignment: Drift Detected`,
              body: body,
              labels: ['governance-ripple-required', 'governance-only']
            });
