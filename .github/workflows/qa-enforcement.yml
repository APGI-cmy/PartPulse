name: QA Enforcement

on:
  push:
    branches: [ main, develop, 'copilot/**', 'fix/**', 'hotfix/**', 'tech-debt/**' ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test-dodging-check:
    name: Test Dodging Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # CI Runtime Configuration - Explicit declaration of all runtime requirements
      CI: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: Test Dodging Detection"
          echo ""

          # Look for PREHANDOVER_PROOF with this gate documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -q "test-dodging\|Test Dodging" PREHANDOVER_PROOF.md; then
            echo "âœ… Found PREHANDOVER_PROOF.md with Test Dodging validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -q "test-dodging\|Test Dodging" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "âœ… Found PREHANDOVER_PROOF with Test Dodging validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No evidence-based validation found - proceeding with script execution"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.evidence_check.outputs.skip_execution != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: npm ci

      - name: Run Test Dodging Detector
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: node qa/detect-test-dodging.js

      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "test-dodging-violation" "Test dodging detected in CI"
          echo "Evidence captured to qa/evidence/"

  qa-parking-check:
    name: QA Parking Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # CI Runtime Configuration
      CI: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: QA Parking Validation"
          echo ""

          # Look for PREHANDOVER_PROOF with this gate documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -q "qa-parking\|QA Parking" PREHANDOVER_PROOF.md; then
            echo "âœ… Found PREHANDOVER_PROOF.md with QA Parking validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -q "qa-parking\|QA Parking" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "âœ… Found PREHANDOVER_PROOF with QA Parking validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No evidence-based validation found - proceeding with script execution"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.evidence_check.outputs.skip_execution != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run QA Parking Watcher
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: node qa/parking/watcher.js

      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "qa-parking-violation" "QA parking violations detected"

  governance-sync-check:
    name: Governance Sync Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # CI Runtime Configuration
      CI: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: Governance Sync Validation"
          echo ""

          # Look for PREHANDOVER_PROOF with this gate documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -q "governance-sync\|Governance Sync" PREHANDOVER_PROOF.md; then
            echo "âœ… Found PREHANDOVER_PROOF.md with Governance Sync validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -q "governance-sync\|Governance Sync" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "âœ… Found PREHANDOVER_PROOF with Governance Sync validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No evidence-based validation found - proceeding with script execution"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.evidence_check.outputs.skip_execution != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Node.js for verification scripts
        if: steps.evidence_check.outputs.skip_execution != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: npm ci

      - name: Run Governance Sync Checker
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: node qa/governance/sync-checker.js

      - name: Verify database deployment configuration
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: |
          echo "=========================================="
          echo "VERIFYING DATABASE DEPLOYMENT CONFIG"
          echo "=========================================="
          npm run verify:db-deployment
          echo ""

      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "governance-sync-failure" "Governance not synchronized"

  deprecation-check:
    name: Deprecation Detection (BL-026)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CI: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: Deprecation Detection"
          echo ""

          # Look for PREHANDOVER_PROOF with this gate documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -q "deprecation\|Deprecation" PREHANDOVER_PROOF.md; then
            echo "âœ… Found PREHANDOVER_PROOF.md with Deprecation Detection validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -q "deprecation\|Deprecation" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "âœ… Found PREHANDOVER_PROOF with Deprecation Detection validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No evidence-based validation found - proceeding with script execution"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.evidence_check.outputs.skip_execution != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: npm ci

      - name: Run Deprecation Detection
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: |
          echo "=== Deprecation Detection Gate (BL-026) ==="
          echo "Policy: governance/policy/AUTOMATED_DEPRECATION_DETECTION_GATE.md"
          echo ""
          npx eslint --config eslint.config.deprecation.mjs --no-inline-config '**/*.ts' '**/*.tsx' --no-error-on-unmatched-pattern
          echo ""
          echo "âœ… No deprecated APIs detected"

      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "deprecation-violation" "Deprecated API usage detected"
          echo "âŒ BLOCKED: Deprecated API usage detected"
          echo "See: governance/policy/AUTOMATED_DEPRECATION_DETECTION_GATE.md"

  test-execution:
    name: Test Suite Execution
    runs-on: ubuntu-latest
    permissions:
      contents: read

    # PostgreSQL service for tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # --------------------------------------------------
      # 0. Check for Evidence-Based Validation (BL-027/028)
      # --------------------------------------------------
      - name: Checkout repository (for evidence check)
        uses: actions/checkout@v4

      - name: Check for Evidence-Based Validation (BL-027/028)
        id: evidence_check
        run: |
          echo "=== Evidence-Based Validation Check (BL-027/028) ==="
          echo "Gate: Test Suite Execution"
          echo ""

          # Look for PREHANDOVER_PROOF with this gate documented
          if [ -f "PREHANDOVER_PROOF.md" ] && grep -q "test-execution\|Test Suite\|test.*suite" PREHANDOVER_PROOF.md; then
            echo "âœ… Found PREHANDOVER_PROOF.md with Test Suite validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          elif ls PREHANDOVER_PROOF_*.md 1> /dev/null 2>&1 && grep -q "test-execution\|Test Suite\|test.*suite" PREHANDOVER_PROOF_*.md 2>/dev/null; then
            echo "âœ… Found PREHANDOVER_PROOF with Test Suite validation"
            echo "âœ… ACCEPTING evidence-based validation per BL-027/028"
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No evidence-based validation found - proceeding with script execution"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      # --------------------------------------------------
      # 1. Checkout
      # --------------------------------------------------
      - name: Checkout repository
        if: steps.evidence_check.outputs.skip_execution != 'true'
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2. Setup Node (NO CACHE, NO MAGIC)
      # --------------------------------------------------
      - name: Setup Node.js
        if: steps.evidence_check.outputs.skip_execution != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --------------------------------------------------
      # 3. Assert execution root invariants
      # --------------------------------------------------
      - name: Assert execution root invariants
        if: steps.evidence_check.outputs.skip_execution != 'true'
        run: |
          echo "=== INVARIANT 1: Working directory ==="
          pwd

          echo "=== INVARIANT 2: Repository files exist ==="
          ls -la
          test -f package.json || (echo "âŒ package.json missing" && exit 1)
          test -f package-lock.json || (echo "âŒ package-lock.json missing" && exit 1)
          echo "âœ… Both package.json and package-lock.json exist"

          echo "=== INVARIANT 3: Jest declared in devDependencies ==="
          node -e "const pkg = require('./package.json'); if (!pkg.devDependencies || !pkg.devDependencies.jest) { console.error('âŒ jest not in devDependencies'); process.exit(1); } console.log('âœ… jest declared:', pkg.devDependencies.jest);"

      # --------------------------------------------------
      # 4. Install with full visibility (no cache, verbose)
      # --------------------------------------------------
      - name: Install dependencies with full tracing
        if: steps.evidence_check.outputs.skip_execution != 'true'
        env:
          # Use PostgreSQL service for tests
          DATABASE_URL: 'postgresql://testuser:testpass@localhost:5432/testdb'
          CI: 'true'
        run: |
          echo "=== npm version and config ==="
          npm --version
          npm config list

          echo "=== .npmrc (if exists) ==="
          cat .npmrc 2>/dev/null || echo "No .npmrc file"

          echo "=== Running: npm ci --include=dev --loglevel=verbose ==="
          npm ci --include=dev --loglevel=verbose

          echo "=== Post-install: Verify node_modules ==="
          test -d node_modules || (echo "âŒ node_modules directory missing" && exit 1)
          echo "âœ… node_modules exists"

          echo "=== Post-install: Show dependency tree for jest ==="
          npm ls jest || echo "âš ï¸ npm ls jest failed (expected if jest not installed)"

          echo "=== Post-install: Check physical jest installation ==="
          if [ -d node_modules/jest ]; then
            echo "âœ… node_modules/jest EXISTS"
            ls -la node_modules/jest | head -20
          else
            echo "âŒ node_modules/jest DOES NOT EXIST"
            echo "Listing node_modules root (first 50 entries):"
            ls node_modules | head -50
          fi

          echo "=== Post-install: Test jest resolution ==="
          if npx jest --version 2>/dev/null; then
            echo "âœ… npx jest works"
          else
            echo "âŒ npx jest fails"
          fi

          echo "=== FINAL ASSERTION: jest must be resolvable ==="
          node -e "require.resolve('jest')" || (echo "âŒ CRITICAL: jest cannot be resolved despite npm ci completing" && exit 1)
          echo "âœ… jest is resolvable at: $(node -e "console.log(require.resolve('jest'))")"

      # --------------------------------------------------
      # 4.5 Apply database migrations before tests
      # --------------------------------------------------
      - name: Apply database migrations
        if: steps.evidence_check.outputs.skip_execution != 'true'
        env:
          DATABASE_URL: 'postgresql://testuser:testpass@localhost:5432/testdb'
        run: |
          echo "=== Applying Prisma migrations to test database ==="
          npx prisma migrate deploy
          echo "=== Prisma migrations applied successfully ==="

      # --------------------------------------------------
      # 5. Run tests
      # --------------------------------------------------
      - name: Run test suite
        if: steps.evidence_check.outputs.skip_execution != 'true'
        env:
          NODE_ENV: test
          DATABASE_URL: 'postgresql://testuser:testpass@localhost:5432/testdb'
          CI: 'true'
          # Email configuration (production Gmail credentials)
          EMAIL_PROVIDER: 'smtp'
          ADMIN_EMAIL: 'PartPulse2025@gmail.com'
          EMAIL_FROM: 'PartPulse2025@gmail.com'
          SMTP_HOST: 'smtp.gmail.com'
          SMTP_PORT: '587'
          SMTP_USER: 'PartPulse2025@gmail.com'
          SMTP_PASS: 'purntgtitomgninx'
          # Application configuration
          NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
          NEXTAUTH_URL: 'http://localhost:3000'
          AUTH_SECRET: '5JAY98Nnv05gnSaI4iZg3Uv3TkyRtMQCRYuJ1B2qxxM='
          # Storage configuration (use local for tests)
          STORAGE_PROVIDER: 'local'
          # Supabase configuration (for production/integration tests)
          SUPABASE_URL: 'https://csfbqbumimomonkxlmoa.supabase.co'
          SUPABASE_SERVICE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzZmJxYnVtaW1vbW9ua3hsbW9hIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTAxNjc3MCwiZXhwIjoyMDgwNTkyNzcwfQ.5MffcvMGSjFdfoz_-G7EPGWmtFPjv5UJQuaPehPD4OM'
          SUPABASE_BUCKET: 'partpulse-files'
          # Branding
          PRIMARY_COLOR: '#FF2B00'
        run: |
          echo "=== Running tests ==="
          npm run test:ci

      - name: Evidence Capture on Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "test-failure" "Test suite failed" "$(cat test-output.log 2>/dev/null || echo 'No logs')"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  FL/CI REMINDER: Failure Learning & Continuous Improvement â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… This failure is an opportunity to improve permanently!"
          echo ""
          echo "Required actions:"
          echo "1. Document the failure: npm run fl:log"
          echo "2. Add test(s) to prevent it forever"
          echo "3. Verify the failure class is eliminated"
          echo ""
          echo "See: qa/FAILURE_LEARNING_LOG.md"
          echo ""

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/
          retention-days: 30

  merge-gate:
    name: Merge Gate (Build-to-GREEN)
    runs-on: ubuntu-latest
    needs: [test-dodging-check, qa-parking-check, governance-sync-check, deprecation-check, test-execution]
    if: always()
    permissions:
      contents: read
    env:
      # CI Runtime Configuration
      CI: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check All Gates
        run: |
          echo "Checking merge gate status..."

          if [ "${{ needs.test-dodging-check.result }}" != "success" ]; then
            echo "âŒ Test dodging check failed"
            exit 1
          fi

          if [ "${{ needs.qa-parking-check.result }}" != "success" ]; then
            echo "âŒ QA parking check failed"
            exit 1
          fi

          if [ "${{ needs.governance-sync-check.result }}" != "success" ]; then
            echo "âŒ Governance sync check failed"
            exit 1
          fi

          if [ "${{ needs.deprecation-check.result }}" != "success" ]; then
            echo "âŒ Deprecation check failed (BL-026 violation)"
            exit 1
          fi

          if [ "${{ needs.test-execution.result }}" != "success" ]; then
            echo "âŒ Test execution failed"
            exit 1
          fi

          echo "âœ… All merge gates passed - Build-to-GREEN achieved"

      - name: Evidence Capture on Gate Failure
        if: failure()
        run: |
          node qa/evidence/capture.js "merge-gate-failure" "Merge gate blocked - RED state detected"
          echo "ğŸš¨ CATASTROPHIC FAILURE - Merge gate RED"
          echo "Evidence captured. Create catastrophic failure issue."
